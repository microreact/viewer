import Paper from "@mui/material/Paper";
import PropTypes from "prop-types";
import React from "react";
import { GlobalHotKeys } from "react-hotkeys";

// import "../styles/viewer.css";

import { keyMap } from "../utils/shortcuts";
import { nextFrame } from "../utils/browser";
import { clearCache } from "../utils/state";
import { emptyObject } from "../constants";

import BusyIndicator from "../containers/BusyIndicator.react";
import DropFiles from "../containers/DropFiles.react";
import FileLoader from "../containers/FileLoader.react";
import HeaderBar from "../containers/HeaderBar.react";
import LayoutManager from "../containers/LayoutManager.react";
import PanesEditor from "../containers/PanesEditor.react";
import clsx from "clsx";

const invertedSpinnerPng = "data:image/png;base64,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";

class Viewer extends React.PureComponent {

  handlers = {
    undo: () => this.props.onUndo(),
    redo: () => this.props.onRedo(),
  }

  // eslint-disable-next-line class-methods-use-this
  componentWillUnmount() {
    nextFrame(
      () => {
        clearCache();
        // clearPhylocanvasCache();
      },
      1000,
    );
  }

  renderViewerContent() {
    const { props } = this;

    if (props.isEmpty) {
      return (<DropFiles key="empty" />);
    }

    return (
      <DropFiles key="non-empty" >
        <GlobalHotKeys
          keyMap={keyMap}
          handlers={this.handlers}
        />

        <HeaderBar
          appendNavButtons={props.components.appendNavButtons}
          drawerButton={props.components.drawerButton}
          prependNavButtons={props.components.prependNavButtons}
        />

        <Paper
          component="main"
          className="mr-viewer-main"
          elevation={0}
          square
        >
          <LayoutManager />
        </Paper>
        { props.children }

        <img
          className="mr-spinner"
          src={invertedSpinnerPng}
        />
      </DropFiles>
    );
  }

  renderDataFileLoaders() {
    const { props } = this;

    // Makes sure that all dataset files have been loaded (i.e. has a _content property)
    for (const dataset of Object.values(props.datasets || emptyObject)) {
      const datasetFileDescriptor = props.files[dataset.file];
      if (!datasetFileDescriptor._content) {
        return (
          <FileLoader
            key={datasetFileDescriptor.id}
            file={datasetFileDescriptor}
          />
        );
      }
    }

    return (
      <React.Fragment>
        { this.renderViewerContent() }

        <BusyIndicator />

        <PanesEditor />

      </React.Fragment>
    );
  }

  render() {
    const { props } = this;

    return (
      <div
        className={
          clsx(
            props.className,
            "microreact-viewer",
          )
        }
        id="microreact-viewer"
      >
        { this.renderDataFileLoaders() }
      </div>
    );
  }

}

Viewer.displayName = "Viewer";

Viewer.propTypes = {
  children: PropTypes.node,
  className: PropTypes.string,
  components: PropTypes.object,
  datasets: PropTypes.object,
  files: PropTypes.object,
  isEmpty: PropTypes.bool.isRequired,
  onRedo: PropTypes.func,
  onUndo: PropTypes.func,
};

Viewer.defaultProps = {
  components: emptyObject,
};

export default Viewer;
